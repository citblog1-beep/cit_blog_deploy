{% extends "base.html" %}
{% block title %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„ - Ù…Ø¯ÙˆÙ†Ø© CIT{% endblock %}

{% block content %}

<section class="form-section form-card">
  <h2 class="form-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„</h2>
  <p style="text-align:center; margin-top:-10px; margin-bottom:15px; color:#64748b;">
    Ø§Ù„Ù‚Ø³Ù…: {{ category_name }} | Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: <code dir="ltr">{{ filename }}</code>
  </p>

  <form method="POST"
        action="{{ url_for('edit_post', category=category, filename=filename) }}"
        id="postForm"
        class="form-add-post">

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„ -->
    <label for="title">ğŸ“Œ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„:</label>
    <input type="text" name="title" id="title" required value="{{ title }}">

    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶ (Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨ØªØºÙŠÙŠØ±Ù‡ Ù‡Ù†Ø§) -->
    <label for="filename">ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø«Ø§Ø¨Øª):</label>
    <input type="text" id="filename" value="{{ filename }}" disabled>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
    <div class="editor-card">
      <div class="editor-header">ğŸ“„ Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ù‚Ø§Ù„</div>
      <div id="editor" class="editor-area"></div>
    </div>

    <!-- Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„ HTML -->
    <input type="hidden" name="content" id="content">

    <button type="submit" class="btn" style="margin-top:20px;">
      ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
    </button>
  </form>
</section>

<!-- Ù…ÙƒØªØ¨Ø§Øª Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const toolbarOptions = [
    [{ header: [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike'],
    [{ color: [] }, { background: [] }],
    [{ align: [] }],
    [{ list: 'ordered' }, { list: 'bullet' }],
    ['blockquote'],
    ['link', 'image', 'video'],
    ['clean']
  ];

  const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'âœï¸ Ø­Ø±Ù‘Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„...',
    modules: { toolbar: toolbarOptions }
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ù‚Ø§Ù„
  const initialContent = {{ content|tojson|safe }};
  quill.root.innerHTML = initialContent;

  // Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù†Ø³Ø® HTML Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
  document.getElementById("postForm").addEventListener("submit", function() {
    document.getElementById("content").value = quill.root.innerHTML;
  });

  // Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ form.html)
  const toolbar = document.querySelector('.ql-toolbar');
  if (toolbar) {
    const uploadButton = document.createElement('button');
    uploadButton.type = 'button';
    uploadButton.innerHTML = "ğŸ“·";
    uploadButton.title = "Ø±ÙØ¹ ØµÙˆØ±Ø©";
    toolbar.appendChild(uploadButton);

    uploadButton.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/upload_image', { method: 'POST', body: formData });
        const data = await res.json();

        if (data.url) {
          const range = quill.getSelection(true);
          quill.insertEmbed(range.index, 'image', data.url);
        } else {
          alert("âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
        }
      };
    });

    // Ø²Ø± Ø¥Ø¯Ø±Ø§Ø¬ YouTube (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù…ÙˆØ§ÙÙ‚ Ù„Ù€ form.html)
    const ytButton = document.createElement("button");
    ytButton.type = "button";
    ytButton.innerHTML = "ğŸ¬";
    ytButton.title = "Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠØ¯ÙŠÙˆ YouTube";
    toolbar.appendChild(ytButton);

    ytButton.addEventListener("click", () => {
      const url = prompt("ğŸ¥ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ YouTube:");
      if (!url) return;

      const match = url.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]+)/);
      if (!match) {
        alert("âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
        return;
      }

      const embedUrl = `https://www.youtube.com/embed/${match[1]}`;
      const range = quill.getSelection(true);
      quill.insertEmbed(range.index, 'video', embedUrl);
    });
  }
});
</script>

{% endblock %}
