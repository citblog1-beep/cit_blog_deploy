{% extends "base.html" %}
{% block title %}âœï¸ Ø£Ø¶Ù Ù…Ù‚Ø§Ù„Ø§Ù‹ - Ù…Ø¯ÙˆÙ†Ø© CIT{% endblock %}

{% block content %}

{% if request.args.get('success') == '1' %}
  <div class="success-message">âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</div>
{% endif %}

<section class="form-section form-card">
  <h2 class="form-title">âœï¸ Ø£Ø¶Ù Ù…Ù‚Ø§Ù„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ù‹Ø§</h2>

  <form method="POST" action="/submit" id="postForm" class="form-add-post">

    <!-- Ø¹Ù†ÙˆØ§Ù† -->
    <label for="title">ğŸ“Œ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„:</label>
    <input type="text" name="title" id="title" required>

    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù -->
    <label for="filename">ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª):</label>
    <input type="text" name="filename" id="filename" required>
    <div id="filename-status" style="margin-top:4px; font-size:0.9rem;"></div>

    <!-- Ø§Ù„Ù‚Ø³Ù… -->
    <label for="category">ğŸ“‚ Ø§Ù„Ù‚Ø³Ù…:</label>
    <select name="category" id="category" required>
      {% if categories %}
        {% for cat in categories %}
          {% set icon = 'ğŸ“‚' %}
          {% if 'Ø¨Ø±Ù…Ø¬' in cat.name %}{% set icon = 'ğŸ› ï¸' %}
          {% elif 'Ø´Ø±ÙˆØ­' in cat.name %}{% set icon = 'ğŸ“š' %}
          {% elif 'Ù…Ù‚Ø§Ù„' in cat.name %}{% set icon = 'ğŸ§ ' %}
          {% elif 'Ø®Ø¯Ù…' in cat.name %}{% set icon = 'ğŸ’¡' %}
          {% elif 'Ø°ÙƒØ§Ø¡' in cat.name %}{% set icon = 'ğŸ¤–' %}
          {% endif %}
          <option value="{{ cat.folder }}">{{ icon }} {{ cat.name }}</option>
        {% endfor %}
      {% else %}
        <option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</option>
      {% endif %}
    </select>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
    <div class="editor-card">
      <div class="editor-header">ğŸ“„ Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ù‚Ø§Ù„</div>

      <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ù…Ù† ØµÙÙ‘ÙŠÙ† -->
      <div id="toolbar" class="ql-toolbar ql-snow custom-toolbar">
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø®Ø· + Ø­Ø¬Ù… + ØªÙ†Ø³ÙŠÙ‚ + Ø£Ù„ÙˆØ§Ù† -->
        <div class="toolbar-row">
          <span class="ql-formats">
            <select class="ql-font">
              <option value="cairo" selected>Cairo</option>
              <option value="sans-serif">Default</option>
            </select>
            <select class="ql-size">
              <option value="small">ØµØºÙŠØ±</option>
              <option selected></option>
              <option value="large">ÙƒØ¨ÙŠØ±</option>
              <option value="huge">Ø¶Ø®Ù…</option>
            </select>
          </span>

          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
            <button class="ql-strike"></button>
          </span>

          <span class="ql-formats">
            <select class="ql-color"></select>
            <select class="ql-background"></select>
          </span>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù‚ÙˆØ§Ø¦Ù… + Ù…Ø­Ø§Ø°Ø§Ø© + Ø§Ù‚ØªØ¨Ø§Ø³ + Ù…ÙŠØ¯ÙŠØ§ + ØªÙ†Ø¸ÙŠÙ -->
        <div class="toolbar-row">
          <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-align" value=""></button>
            <button class="ql-align" value="center"></button>
            <button class="ql-align" value="right"></button>
            <button class="ql-align" value="justify"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-blockquote"></button>
          </span>

          <span class="ql-formats">
            <!-- Ø£Ø²Ø±Ø§Ø± Ù…Ø®ØµØµØ© -->
            <button type="button" class="ql-uploadImage" title="Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ">ğŸ“·</button>
            <button type="button" class="ql-uploadVideo" title="Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠØ¯ÙŠÙˆ YouTube">ğŸ¬</button>

            <!-- Ø£Ø¯ÙˆØ§Øª Quill Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
            <button class="ql-link"></button>
            <button class="ql-image"></button>
            <button class="ql-video"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-clean"></button>
          </span>
        </div>
      </div>

      <div id="editor" class="editor-area"></div>
    </div>

    <!-- Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ­Ù…Ù„ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ -->
    <input type="hidden" name="content" id="content">

    <!-- Ø²Ø± Ø§Ù„Ù†Ø´Ø± -->
    <button type="submit" class="btn" style="margin-top:20px;">âœ… Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„</button>
  </form>
</section>

<!-- Ù…ÙƒØªØ¨Ø§Øª Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  /* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· ========== */
  const Font = Quill.import('formats/font');
  Font.whitelist = ['cairo', 'sans-serif'];
  Quill.register(Font, true);

  /* ========== ØªÙ‡ÙŠØ¦Ø© Quill Ù…Ø¹ Ø§Ù„ØªÙˆÙ„Ø¨Ø§Ø± Ø§Ù„Ù…Ø®ØµØµ ========== */
  const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'âœï¸ Ø§ÙƒØªØ¨ Ù…Ù‚Ø§Ù„Ùƒ Ù‡Ù†Ø§...',
    modules: { toolbar: '#toolbar' }
  });

  const DRAFT_KEY = "draft_post";
  const params = new URLSearchParams(window.location.search);
  const isSuccess = params.get("success") === "1";

  const titleInput = document.getElementById("title");
  const filenameInput = document.getElementById("filename");
  const categorySelect = document.getElementById("category");

  /* ========== Ù…Ø³ÙˆØ¯Ø© / Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ========= */
  if (isSuccess) {
    localStorage.removeItem(DRAFT_KEY);
    if (titleInput) titleInput.value = "";
    if (filenameInput) filenameInput.value = "";
    if (categorySelect) categorySelect.selectedIndex = 0;
    quill.setContents([]);
  } else {
    const savedDraft = localStorage.getItem(DRAFT_KEY);
    if (savedDraft) {
      try {
        const draft = JSON.parse(savedDraft);
        if (draft.title && titleInput) titleInput.value = draft.title;
        if (draft.filename && filenameInput) filenameInput.value = draft.filename;
        if (draft.content) quill.root.innerHTML = draft.content;
        if (draft.category && categorySelect) categorySelect.value = draft.category;
      } catch (e) {
        console.warn("Failed to parse draft_post:", e);
      }
    }
  }

  setInterval(() => {
    const draft = {
      title: titleInput ? titleInput.value : "",
      filename: filenameInput ? filenameInput.value : "",
      category: categorySelect ? categorySelect.value : "",
      content: quill.root.innerHTML
    };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
  }, 10000);

  /* ========== ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ========= */
  titleInput.addEventListener("input", () => {
    let value = titleInput.value
      .trim()
      .toLowerCase()
      .replace(/[\u0600-\u06FF]/g, "")
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
    filenameInput.value = value;
  });

  /* ========== ÙØ­Øµ ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ========= */
  filenameInput.addEventListener("input", checkFilename);
  categorySelect.addEventListener("change", checkFilename);

  async function checkFilename() {
    const filename = filenameInput.value.trim();
    const category = categorySelect.value;
    const statusBox = document.getElementById("filename-status");

    if (!filename) {
      statusBox.textContent = "";
      return;
    }

    try {
      const res = await fetch(
        `/check_filename?category=${encodeURIComponent(category)}&filename=${encodeURIComponent(filename)}`
      );
      const data = await res.json();

      if (data.exists) {
        statusBox.innerHTML = "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§ â€” Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ø¢Ø®Ø±";
        statusBox.style.color = "#b91c1c";
      } else {
        statusBox.innerHTML = "âœ”ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ØªØ§Ø­";
        statusBox.style.color = "#15803d";
      }
    } catch (e) {
      console.error("Filename check failed:", e);
      statusBox.innerHTML = "âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¢Ù†";
      statusBox.style.color = "#92400e";
    }
  }

  /* ========== Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù†Ø³Ø® HTML ========= */
  document.getElementById("postForm").addEventListener("submit", function() {
    document.querySelector("#content").value = quill.root.innerHTML;
  });

  /* ========== Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ========= */
  const uploadBtn = document.querySelector('.ql-uploadImage');
  if (uploadBtn) {
    uploadBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/upload_image', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.url) {
            const range = quill.getSelection(true) || { index: quill.getLength() };
            quill.insertEmbed(range.index, 'image', data.url);
          } else {
            alert("âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
          }
        } catch (e) {
          console.error("Upload failed:", e);
          alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
        }
      };
    });
  }

  /* ========== Ø²Ø± Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠØ¯ÙŠÙˆ YouTube ========= */
  const ytBtn = document.querySelector('.ql-uploadVideo');
  if (ytBtn) {
    ytBtn.addEventListener("click", () => {
      const url = prompt("ğŸ¥ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ YouTube:");
      if (!url) return;

      const match = url.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]+)/);
      if (!match) {
        alert("âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");
        return;
      }

      const embedUrl = `https://www.youtube.com/embed/${match[1]}`;
      const range = quill.getSelection(true) || { index: quill.getLength() };
      quill.insertEmbed(range.index, 'video', embedUrl);
    });
  }

});
</script>

{% endblock %}
